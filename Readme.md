# CSVKeychain AppleScript script

This script allows you to export all your password items and secure notes from
Apple's Keychain.app into a plain text file in CSV format, and it allows you to
import CSV files back into a keychain.

The script does not use any trick or reverse engineering: it just uses Apple's
`security` tool and takes advantage of macOS's assistive support.

Tested in macOS Sierra. Earlier versions of macOS/OS X are not supported.


## How to use

You may run the script from source. Just open it in Script Editor.

Before running the script, go to System Preferences > Security & Privacy >
Accessibility, and allow Script Editor to control your computer. This step is
required to avoid SecurityAgent to prompt you with a dialog for each item you
want to export. It basically allows AppleScript to press the Allow button in
such dialogs for you.

You may also build the script into an application if you want. In this case, you
must grant the app control of your computer in the same way.

The script makes a backup of your keychain before importing or exporting data.
Backups are timestamped and saved into the same folder containing the keychain.
In any case, it is a good idea to keep a separate backup, just in case.

When importing items into a keychain, matching items in the keychain are
overwritten if their timestamps are older than the timestamps of the items being
imported. If a keychain's item has no timestamp, then the item is duplicated. If
there are items without timestamps in the CSV file, the script asks the user
what to do.

You may use this script to merge two or more keychains:

1. Export each keychain, one at a time.
2. Open Keychain.app and create a new keychain.
3. Import each exported CSV file, one at a time, into the new keychain.

**Note:** currently, access control lists are not exported.


## Is it possible to export the Local Items (aka iCloud) keychain?

Not directly. The Local Items keychain, located at
`~/Library/Keychain/<UUID>/<name>.db`, is a SQLite3 database containing
obfuscated data, so its format is different from the format of a standard
keychain. As far as I can see, `security` cannot dump such keychains, and I do
not know of any tool that would do that.

You may proceed as follows:

1. In Keychain.app, create a new keychain: File > New Keychain…
2. Select the Local Items keychain in the sidebar, then select all the items
   (or the ones you want to export) and copy them by choosing Edit > Copy.
3. Select the keychain created at step one and choose Edit > Paste.

Such process is painful, though, because Keychain.app will keep asking for
a password for each item. You may automate such process with [a bit of
scripting](https://gist.github.com/rmondello/b933231b1fcc83a7db0b). For your
convenience, the script that allows you to fill in the password prompts for you
is reported below:

```applescript
set keychainPassword to "keychain password"

tell application "System Events"
    repeat while exists (processes where name is "SecurityAgent")
        tell process "SecurityAgent"
            set value of text field 1 of window 1 to keychainPassword
            click button "OK" of window 1
        end tell
        delay 0.2
    end repeat
end tell
```

You may run this directly from Script Editor.

## Migrate passwords and notes into KeePass

If you want to import the CSV file generated by this script into a KeePass
2 database and you are on macOS, you may need to convert it to XML first. For
such purpose, it is recommended that you add a category column to the CSV file
using the included `add_category.rb` script (you may skip this step if you want
to group all your passwords under the “General” category). Then, use my
[csv2keepassxml](https://github.com/lifepillar/csv2keepassxml) to generate
a KeePass 2 XML file.


## License

Copyright (c) 2011–2017, Lifepillar

Permission is hereby granted, free of charge, to any person obtaining a copy of
this software and associated documentation files (the "Software"), to deal in
the Software without restriction, including without limitation the rights to
use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of
the Software, and to permit persons to whom the Software is furnished to do so,
subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS
FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR
COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER
IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
